<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA Fitness Sherman Oaks | San Fernando Valley Directory</title>
    <meta name="description" content="LA Fitness Sherman Oaks - Full-service fitness center with modern equipment and group classes. Contact info, hours, and amenities.">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full">
    <!-- Navigation (same as your homepage) -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 justify-between items-center">
                <div class="flex items-center">
                    <a href="/" class="flex items-center">
                        <span class="text-2xl font-bold text-blue-600">SFV Directory</span>
                    </a>
                </div>
                
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-8">
                        <a href="/#categories" class="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm font-medium transition-colors">Categories</a>
                        <a href="/#neighborhoods" class="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm font-medium transition-colors">Neighborhoods</a>
                        <a href="/#search" class="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm font-medium transition-colors">Search</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Loading State -->
    <div id="loading" class="min-h-screen bg-gray-50 py-8">
        <div class="max-w-4xl mx-auto px-4">
            <div class="animate-pulse">
                <div class="h-8 bg-gray-200 rounded w-1/4 mb-4"></div>
                <div class="h-64 bg-gray-200 rounded mb-8"></div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-4">
                        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                        <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="error" class="min-h-screen bg-gray-50 py-8" style="display: none;">
        <div class="max-w-4xl mx-auto px-4">
            <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                <h2 class="text-xl font-semibold text-red-800 mb-2">Business Not Found</h2>
                <p class="text-red-600" id="error-message"></p>
                <button 
                    onclick="window.history.back()" 
                    class="mt-4 inline-flex items-center px-4 py-2 border border-red-300 rounded-md text-sm font-medium text-red-700 bg-white hover:bg-red-50"
                >
                    Go Back
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="content" class="min-h-screen bg-gray-50" style="display: none;">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-4xl mx-auto px-4 py-6">
                <nav class="text-sm breadcrumbs mb-4">
                    <ol class="flex items-center space-x-2 text-gray-500" id="breadcrumbs">
                        <!-- Breadcrumbs will be populated by JavaScript -->
                    </ol>
                </nav>
                
                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between">
                    <div class="flex-1">
                        <h1 class="text-3xl font-bold text-gray-900 mb-2" id="business-name"></h1>
                        <div class="flex flex-wrap gap-2 mb-4" id="header-tags">
                            <!-- Tags will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-3 mt-4 sm:mt-0" id="action-buttons">
                        <!-- Action buttons will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column - Main Info -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- About -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6" id="about-section">
                        <h2 class="text-lg font-semibold text-gray-900 mb-3">About</h2>
                        <p class="text-gray-600 leading-relaxed" id="business-description"></p>
                    </div>

                    <!-- Contact Info -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Contact Information</h2>
                        <div class="space-y-3" id="contact-info">
                            <!-- Contact info will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Amenities & Features -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6" id="features-section">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Features & Amenities</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="features-grid">
                            <!-- Features will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Right Column - Sidebar -->
                <div class="space-y-6">
                    <!-- Business Hours -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6" id="hours-section">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Hours</h2>
                        <div class="space-y-2" id="business-hours">
                            <!-- Hours will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Related Businesses -->
                    <div class="bg-white rounded-lg border border-gray-200 p-6" id="related-section">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4" id="related-title"></h2>
                        <div class="space-y-3" id="related-businesses">
                            <!-- Related businesses will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200">
        <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
            <div class="text-center">
                <p class="text-sm text-gray-500">&copy; 2025 San Fernando Valley Directory. Find local businesses in the SFV.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://rnkbkjnxnumqtctetyvz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJua2Jram54bnVtcXRjdGV0eXZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NTQ0NjUsImV4cCI6MjA3MjIzMDQ2NX0.0I_IhSSq4g2kh_A55uDmg7TcieWaonMK33UQPc-lC14';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Get business slug from URL
        function getBusinessSlug() {
            const path = window.location.pathname;
            const parts = path.split('/');
            return parts[parts.length - 1] || 'la-fitness-sherman-oaks'; // default for testing
        }

        // Format business hours
        function formatBusinessHours(hoursData) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const formattedHours = {};
            
            hoursData.forEach(hour => {
                const dayName = days[hour.day_of_week];
                if (hour.is_24_hour) {
                    formattedHours[dayName] = '24 Hours';
                } else if (hour.is_closed) {
                    formattedHours[dayName] = 'Closed';
                } else {
                    const openTime = new Date(`2000-01-01T${hour.open_time}`).toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit', 
                        hour12: true 
                    });
                    const closeTime = new Date(`2000-01-01T${hour.close_time}`).toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit', 
                        hour12: true 
                    });
                    formattedHours[dayName] = `${openTime} - ${closeTime}`;
                }
            });

            return formattedHours;
        }

        // Categorize tags by type
        function categorizeTagsByType(businessTags) {
            const categorized = {
                payment: [],
                amenity: [],
                location: [],
                specialization: [],
                pricing: [],
                service: [],
                urgency: []
            };

            businessTags?.forEach(bt => {
                if (bt.tags) {
                    categorized[bt.tags.tag_type]?.push(bt.tags);
                }
            });

            return categorized;
        }

        // Generate Google Maps URL
        function getGoogleMapsUrl(address) {
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
        }

        // Render business content
        function renderBusiness(business, businessHours, relatedBusinesses) {
            const categorizedTags = categorizeTagsByType(business.business_tags);
            const formattedHours = formatBusinessHours(businessHours);

            // Update page title
            document.title = `${business.name} | San Fernando Valley Directory`;
            
            // Breadcrumbs
            document.getElementById('breadcrumbs').innerHTML = `
                <li><a href="/" class="hover:text-blue-600">Home</a></li>
                <li class="before:content-['/'] before:mx-2">
                    <a href="/#categories" class="hover:text-blue-600">${business.categories?.name}</a>
                </li>
                <li class="before:content-['/'] before:mx-2 text-gray-900 font-medium">${business.name}</li>
            `;

            // Business name
            document.getElementById('business-name').textContent = business.name;

            // Header tags
            let headerTagsHTML = `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                    ${business.categories?.name}
                </span>
            `;
            categorizedTags.location.forEach(tag => {
                headerTagsHTML += `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                        ${tag.name}
                    </span>
                `;
            });
            document.getElementById('header-tags').innerHTML = headerTagsHTML;

            // Action buttons
            let actionsHTML = '';
            if (business.phone) {
                actionsHTML += `
                    <a href="tel:${business.phone}" class="inline-flex items-center justify-center px-4 py-2 border border-blue-300 rounded-md text-sm font-medium text-blue-700 bg-white hover:bg-blue-50">
                        Call ${business.phone}
                    </a>
                `;
            }
            actionsHTML += `
                <a href="${getGoogleMapsUrl(business.address)}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
                    Get Directions
                </a>
            `;
            document.getElementById('action-buttons').innerHTML = actionsHTML;

            // About section
            if (business.description) {
                document.getElementById('business-description').textContent = business.description;
            } else {
                document.getElementById('about-section').style.display = 'none';
            }

            // Contact info
            let contactHTML = `
                <div class="flex items-start">
                    <svg class="h-5 w-5 text-gray-400 mt-1 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <div>
                        <p class="text-gray-900">${business.address}</p>
                        <a href="${getGoogleMapsUrl(business.address)}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-700 text-sm">
                            View on Google Maps
                        </a>
                    </div>
                </div>
            `;

            if (business.phone) {
                contactHTML += `
                    <div class="flex items-center">
                        <svg class="h-5 w-5 text-gray-400 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                        <a href="tel:${business.phone}" class="text-blue-600 hover:text-blue-700">${business.phone}</a>
                    </div>
                `;
            }

            if (business.website) {
                contactHTML += `
                    <div class="flex items-center">
                        <svg class="h-5 w-5 text-gray-400 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                        </svg>
                        <a href="${business.website}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-700">
                            Visit Website
                        </a>
                    </div>
                `;
            }
            document.getElementById('contact-info').innerHTML = contactHTML;

            // Features & Amenities
            let featuresHTML = '';
            const tagCategories = [
                { key: 'specialization', label: 'Specializations', color: 'orange' },
                { key: 'amenity', label: 'Amenities', color: 'green' },
                { key: 'payment', label: 'Payment Methods', color: 'purple' },
                { key: 'service', label: 'Services', color: 'blue' }
            ];

            tagCategories.forEach(category => {
                if (categorizedTags[category.key].length > 0) {
                    featuresHTML += `
                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-2">${category.label}</h3>
                            <div class="flex flex-wrap gap-2">
                    `;
                    categorizedTags[category.key].forEach(tag => {
                        featuresHTML += `
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${category.color}-100 text-${category.color}-800">
                                ${tag.name}
                            </span>
                        `;
                    });
                    featuresHTML += '</div></div>';
                }
            });

            if (featuresHTML) {
                document.getElementById('features-grid').innerHTML = featuresHTML;
            } else {
                document.getElementById('features-section').style.display = 'none';
            }

            // Business hours
            if (businessHours.length > 0) {
                let hoursHTML = '';
                Object.entries(formattedHours).forEach(([day, hours]) => {
                    hoursHTML += `
                        <div class="flex justify-between">
                            <span class="text-gray-600">${day}</span>
                            <span class="text-gray-900 font-medium">${hours}</span>
                        </div>
                    `;
                });
                document.getElementById('business-hours').innerHTML = hoursHTML;
            } else {
                document.getElementById('hours-section').style.display = 'none';
            }

            // Related businesses
            if (relatedBusinesses.length > 0) {
                document.getElementById('related-title').textContent = `More ${business.categories?.name}`;
                let relatedHTML = '';
                relatedBusinesses.slice(0, 10).forEach(relatedBusiness => {
                    const locationTag = relatedBusiness.business_tags?.find(bt => 
                        bt.tags?.tag_type === 'location'
                    )?.tags?.name;
                    
                    relatedHTML += `
                        <div class="border-b border-gray-100 pb-3 last:border-b-0 last:pb-0">
                            <a href="/business/${relatedBusiness.slug}" class="block hover:bg-gray-50 p-2 rounded -m-2 transition-colors">
                                <h3 class="font-medium text-gray-900 text-sm">${relatedBusiness.name}</h3>
                                ${locationTag ? `<p class="text-xs text-gray-500 mt-1">${locationTag}</p>` : ''}
                            </a>
                        </div>
                    `;
                });
                document.getElementById('related-businesses').innerHTML = relatedHTML;
            } else {
                document.getElementById('related-section').style.display = 'none';
            }
        }

        // Main function to load business data
        async function loadBusinessData() {
            const businessSlug = getBusinessSlug();
            
            try {
                // First, fetch basic business data
                const { data: businessData, error: businessError } = await supabase
                    .from('businesses')
                    .select(`
                        *,
                        categories (name, slug)
                    `)
                    .eq('slug', businessSlug)
                    .eq('status', 'active')
                    .single();

                if (businessError) throw businessError;
                if (!businessData) throw new Error('Business not found');

                // Then fetch business tags separately
                const { data: tagsData, error: tagsError } = await supabase
                    .from('business_tags')
                    .select(`
                        tags (name, slug, tag_type)
                    `)
                    .eq('business_id', businessData.id);

                if (tagsError) throw tagsError;

                // Combine the data
                businessData.business_tags = tagsData || [];

                if (businessError) throw businessError;
                if (!businessData) throw new Error('Business not found');

                // Fetch business hours
                const { data: hoursData, error: hoursError } = await supabase
                    .from('business_hours')
                    .select('*')
                    .eq('business_id', businessData.id)
                    .order('day_of_week');

                if (hoursError) throw hoursError;

                // Fetch related businesses (same category, different business, max 10)
                const { data: relatedData, error: relatedError } = await supabase
                    .from('businesses')
                    .select(`
                        *,
                        categories (name, slug)
                    `)
                    .eq('category_id', businessData.category_id)
                    .neq('id', businessData.id)
                    .eq('status', 'active')
                    .limit(10);

                if (relatedError) throw relatedError;

                // Fetch tags for related businesses
                if (relatedData && relatedData.length > 0) {
                    const relatedBusinessIds = relatedData.map(b => b.id);
                    const { data: relatedTagsData, error: relatedTagsError } = await supabase
                        .from('business_tags')
                        .select(`
                            business_id,
                            tags (name, slug, tag_type)
                        `)
                        .in('business_id', relatedBusinessIds);

                    if (!relatedTagsError && relatedTagsData) {
                        // Group tags by business_id
                        const tagsByBusiness = {};
                        relatedTagsData.forEach(item => {
                            if (!tagsByBusiness[item.business_id]) {
                                tagsByBusiness[item.business_id] = [];
                            }
                            tagsByBusiness[item.business_id].push(item);
                        });

                        // Add tags to each related business
                        relatedData.forEach(business => {
                            business.business_tags = tagsByBusiness[business.id] || [];
                        });
                    }
                }

                // Render the business
                renderBusiness(businessData, hoursData || [], relatedData || []);

                // Show content, hide loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (error) {
                console.error('Error loading business:', error);
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        // Load data when page loads
        window.addEventListener('load', loadBusinessData);
    </script>
</body>
</html>
